# SDN实验环境的拓扑搭建说明



##### 使用四台linux服务器，搭建SDN网络环境

其中一台服务器上部署OpenDaylight作为控制平面，另外三台服务器上要搭建一个数据平面。下面详细说一下数据平面拓扑的搭建。主要应用了基于vlan的路径隔离技术和私有协议。



## 数据平面搭建说明



### 数据平面拓扑需求：

​	能在三台服务器上搭建了一个形如Internet2的拓扑。



### Internet2拓扑如图：

​																				后面补图



### 拓扑相关元素：

​	数据平面使用ovs作为虚拟交换机节点，使用linux的network namespace作为虚拟主机节点，使用linux的Tap设备以及veth设备作为虚拟链路。



### 主要思路：

​	Internet2拓扑总一共有17个主要的交换节点，我们将17个节点根据地理位置分割成三部分，分别部署在三台服务器上。

​	在第一台服务器上有s1、s2、s3、s4、s5、s7六个交换节点；在第二台服务器上有s8、s9、s10、s11、s17五个交换节点；在第三服务器上有s6、s12、s13、s14、s15、s16六个交换机节点。



### 难点提出以及使用vlan路径隔离的方法：

####   难点提出：

如果一条链路的两端节点都在一台服务器内，那么这个链路就在服务器内，可以直接创建虚拟链路来代替它。但是如果一条链路两端的节点分属于不同的服务器，那么这条链路就是跨服务器的链路，<u>跨服务器的虚拟链路要创建在额外的物理链路上。一条跨服务器的虚拟链路如何创建是一个主要的问题</u>。

####   尝试方法1：将两台服务器的网卡链接上作为一条物理链路，虚拟链路创建在这条物理链路上。

* 说明：如果一条链路跨两台服务器，可以在这两台服务器的多余网卡之间创建物理链路，然后物理链路作为虚拟链路的一部分。

* 问题：一条跨服务器的链路需要额外提供一个网卡，实际上一台服务器上有3-5条跨服务器的链路，需要3-5个额外的网卡，但我们使用的服务器只有一个多余的网卡，所以尝试方法2。

####   尝试方法2：使用一个普通的以太网二层交换机，每个服务器链接到交换机上互连。

* 说明：多台服务器的数据平面之间用二层交换机互连，即每台服务器只需要提供一个额外的网卡连接到交换机。然后虚拟链路的一端都绑定到网卡上，虚拟链路的流量由物理交换机转发。
* 问题：虽然各服务器的数据平面通过物理交换机互连了，但服务器之间的拓扑是一个星形拓扑，一个服务器发出去的包，其他服务器的网卡都会受到，进而有关的虚拟链路都会收到。这个拓扑与我们需要的Internet2拓扑不同。

####   最终解决方法：基于使用vlan的路径隔离

* ##### 基于交换机端口的vlan技术简介：

  交换机给各个端口发来的流量打上相应的vlan标签，然后带有vlan标签的流量只能从特定端口转发。交换机通过这种方式将一个物理网络划分成多个vlan网络。

* ##### 方法说明：

  在每个服务器内再创建一个使用VLAN的ovs（以下简称vlan-ovs）。这个ovs一方面与所有需要跨服务器的虚拟链路连接，另一方面与服务器的出端口（网卡）连接。

  **最终形成的拓扑样貌为：每个服务器内的虚拟链路连接到一个vlan-ovs交换机，各个服务器的vlan-ovs交换机借助外部网络连通，外部网络就是使用二层以太网交换机的物理网络。**

* ##### 转发流程：

  每条虚拟链路配一个vlan标签，用不同vlan标签区分不同的虚拟链路。vlan-ovs收到虚拟链路一端的数据包后，打上正确的标签，通过物理网络转发到其他服务器上的vlan-ovs，它们收到后，根据数据包头的标签将流量从特定端口转发，即转发到到同一虚拟链路的另一端。

* ##### 小结：

  通过使用基于vlan的路径隔离技术，我们在三台服务器之间实现了不同虚拟链路的隔离。虽然跨服务器的多条虚拟链路共享同一个物理网络，但是这些链路上的流量在物理网络两端会通过vlan-ovs隔离，达到逻辑上的多条链路，从而能够构建各种想要的拓扑。

### 最终数据平面的详细拓扑如图：

​																			后面补图



### 私有协议：

​	我们实际物理网络中使用的交换机是一台普通的以太网二层交换机，没有vlan功能。即这个交换机是基于mac地址学习的方法转发流量的。而使用这样的交换机是无法将多个服务器之间连通的，下面说明存在的问题。

##### 使用普通二层交换机带来的mac地址学习两次的问题：

​	假设服务器1和服务器2之间有两条不同的虚拟链路分别是vlan100和vlan200。这两条虚拟链路建立在物理网络（二层交换机）之上。那么当一个数据包经过虚拟链路vlan100从服务器1发给服务器2时，交换机记录一下mac地址，当数据包经过虚拟链路vlan200从服务器2又发给服务器1时，交换机又记录了一次mac地址。

​	这种mac地址与端口映射的不断变化会导致交换机失效。导致转发出问题。

##### 使用私有协议解决：

​	说明：在实验设备的限制下，我们没有带vlan功能的交换机作为物理网络。所以我们需要使用私有协议的范式使二层交换机工作的像一台hub设备。即这个交换机会从一个端口收到一个广播包，然后从其他端口转发。这样服务器之间就通过一个hub设备互连。

​	方法：在每个服务器内，vlan-ovs的出端口和网卡之间插入一个**增/删广播头模块**，该模块功能是在出入的数据包前增加一层广播协议，即往外发的数据包增加一层广播头，往内发的数据包去掉一层广播头。通过这样的方式让物理的二层交换机像hub一样工作，从而连通多台服务器。	







ps：之后会补充图片，还有创建vlan-ovs的代码